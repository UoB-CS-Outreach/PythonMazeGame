<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Maze Game â€“ Browser Version</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #050816;
      --panel: #0b1020;
      --accent: #4a61ff;
      --accent-soft: #232c4a;
      --text: #f4f4ff;
      --muted: #9ca3af;
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      --radius: 10px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: var(--font-sans);
      background: radial-gradient(circle at top, #111827 0, #050816 45%, #02030a 100%);
      color: var(--text);
      display: flex;
      gap: 16px;
      min-height: 100vh;
    }

    #left, #center, #right {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #left { flex: 0 0 auto; }
    #center { flex: 1; }
    #right { flex: 0 0 260px; }

    canvas {
      background: #020817;
      border-radius: var(--radius);
      box-shadow: 0 12px 40px rgba(0,0,0,0.65);
    }

    h2 {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
      color: var(--muted);
    }

    #code {
      width: 100%;
      height: 420px;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid #111827;
      background: var(--panel);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 14px;
      resize: vertical;
      line-height: 1.4;
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    #code:focus {
      outline: 1px solid var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft), 0 14px 45px rgba(0,0,0,0.7);
    }

    #output {
      width: 100%;
      height: 420px;
      padding: 10px;
      border-radius: var(--radius);
      border: 1px solid #111827;
      background: #030712;
      color: #9efaa5;
      font-family: var(--font-mono);
      font-size: 13px;
      overflow-y: auto;
      white-space: pre-wrap;
      box-shadow: 0 8px 24px rgba(0,0,0,0.6);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      margin-right: 6px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--accent);
      color: #fff;
      box-shadow: 0 8px 22px rgba(0,0,0,0.6);
      transition: all 0.12s ease-out;
    }

    button.secondary {
      background: transparent;
      color: var(--muted);
      border: 1px solid #111827;
      box-shadow: none;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 26px rgba(0,0,0,0.7);
      background: #5b6dff;
    }

    button.secondary:hover {
      background: #111827;
      color: var(--text);
      box-shadow: 0 10px 22px rgba(0,0,0,0.65);
    }

    #speedWrapper {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-left: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    #speed {
      width: 120px;
    }

    #status {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    @media (max-width: 1000px) {
      body { flex-direction: column; }
      #right { flex: 1; }
    }
  </style>

  <!-- Pyodide runtime -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
</head>
<body>
  <div id="left">
    <h2>Maze</h2>
    <canvas id="mazeCanvas" width="520" height="520"></canvas>
    <div>
      <button id="runBtn">â–¶ Run</button>
      <button id="resetBtn" class="secondary">âŸ² Reset</button>
      <div id="speedWrapper">
        Speed <input id="speed" type="range" min="10" max="300" value="80">
      </div>
    </div>
    <div id="status"></div>
  </div>

  <div id="center">
    <h2>Program</h2>
    <textarea id="code" spellcheck="false"></textarea>
  </div>

  <div id="right">
    <h2>Output</h2>
    <div id="output"></div>
  </div>

  <script type="text/javascript">
    let pyodide = null;
    let running = false;
    let currentMaze = null;

    const canvas = document.getElementById("mazeCanvas");
    const ctx = canvas.getContext("2d");
    const codeEditor = document.getElementById("code");
    const outputEl = document.getElementById("output");
    const statusEl = document.getElementById("status");
    const speedEl = document.getElementById("speed");
    const runBtn = document.getElementById("runBtn");
    const resetBtn = document.getElementById("resetBtn");

    function log(msg) {
      outputEl.textContent += msg + "\\n";
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    function clearLog() {
      outputEl.textContent = "";
    }

    function setStatus(text) {
      statusEl.textContent = text || "";
    }

    function asJsArray(pyObj) {
      if (!pyObj) return pyObj;
      if (Array.isArray(pyObj)) return pyObj;
      if (typeof pyObj.toJs === "function") {
        return pyObj.toJs({ deep: true });
      }
      return pyObj;
    }

    function drawMaze(mazePy) {
      const maze = asJsArray(mazePy);
      if (!maze || !maze.length) return;
      currentMaze = maze;

      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const rows = maze.length;
      const cols = maze[0].length;
      const cellSize = 40;
      const margin = 10;

      for (let r = 0; r < rows; r++) {
        const row = maze[r];
        for (let c = 0; c < cols; c++) {
          const ch = row[c];
          const x = margin + c * cellSize;
          const y = margin + r * cellSize;

          let fill = "#020817";
          if (ch === "#") fill = "#111827";
          if (ch === "S") fill = "#111827";
          if (ch === "G") fill = "#064e3b";

          ctx.fillStyle = fill;
          ctx.fillRect(x, y, cellSize, cellSize);

          ctx.strokeStyle = "#1f2937";
          ctx.strokeRect(x + 0.5, y + 0.5, cellSize - 1, cellSize - 1);

          if (ch === "S") {
            ctx.fillStyle = "#38bdf8";
            ctx.font = "bold 14px system-ui";
            ctx.fillText("S", x + cellSize / 2 - 4, y + cellSize / 2 + 5);
          } else if (ch === "G") {
            ctx.fillStyle = "#bbf7d0";
            ctx.font = "bold 14px system-ui";
            ctx.fillText("G", x + cellSize / 2 - 4, y + cellSize / 2 + 5);
          }
        }
      }
    }

    function drawAgent(row, col, dir) {
      if (!currentMaze) return;

      // Redraw maze so the agent doesn't leave a trail
      drawMaze(currentMaze);

      const cellSize = 40;
      const margin = 10;
      const cx = margin + col * cellSize + cellSize / 2;
      const cy = margin + row * cellSize + cellSize / 2;
      const s = cellSize * 0.34;

      let pts;
      if (dir === 0) { // up
        pts = [cx, cy - s, cx - s * 0.7, cy + s * 0.6, cx + s * 0.7, cy + s * 0.6];
      } else if (dir === 1) { // right
        pts = [cx + s, cy, cx - s * 0.6, cy - s * 0.7, cx - s * 0.6, cy + s * 0.7];
      } else if (dir === 2) { // down
        pts = [cx, cy + s, cx - s * 0.7, cy - s * 0.6, cx + s * 0.7, cy - s * 0.6];
      } else { // left
        pts = [cx - s, cy, cx + s * 0.6, cy - s * 0.7, cx + s * 0.6, cy + s * 0.7];
      }

      ctx.fillStyle = "#4f46e5";
      ctx.strokeStyle = "#1d1b4f";
      ctx.lineWidth = 2;

      ctx.beginPath();
      ctx.moveTo(pts[0], pts[1]);
      ctx.lineTo(pts[2], pts[3]);
      ctx.lineTo(pts[4], pts[5]);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();
    }

    function youWin() {
      log("ðŸŽ‰ Goal reached!");
      setStatus("Finished: goal reached.");
      running = false;
    }

    async function init() {
      setStatus("Loading Python runtime...");
      pyodide = await loadPyodide();

      // Load and register the engine
      const resp = await fetch("maze_engine.py");
      const engineSrc = await resp.text();
      pyodide.runPython(engineSrc); // defines MazeEngine & UserCodeError

      // Wire JS callbacks into Python globals
      pyodide.globals.set("log_fn", (msg) => log(msg));
      pyodide.globals.set("draw_maze_fn", (maze) => drawMaze(maze));
      pyodide.globals.set("draw_agent_fn", (r, c, d) => drawAgent(r, c, d));
      pyodide.globals.set("win_fn", () => youWin());

      // Simple built-in maze (swap this for your own if you like)
      const mazeStr = [
        "###########",
        "#S    #   #",
        "# ## ### ##",
        "#    #    #",
        "#### # ####",
        "#    #    #",
        "# ###### ##",
        "#      #  #",
        "## ### ## #",
        "#   #    G#",
        "###########",
      ].join("\\n");

      pyodide.globals.set("maze_str", mazeStr);

      // Create engine instance in Python
      pyodide.runPython(`
engine = MazeEngine(
    maze_str,
    log_fn=log_fn,
    draw_maze_fn=draw_maze_fn,
    draw_agent_fn=draw_agent_fn,
    win_fn=win_fn,
)
      `);

      // Default example program
      codeEditor.value =
`# Allowed:
#   move(), turn_left(), turn_right()
#   at_goal(), path_ahead(), path_left(), path_right()
#   while, if / elif / else, for ... in range(...)
#
# Goal: guide the robot from S to G.

while not at_goal():
    if path_ahead():
        move()
    else:
        turn_left()`;

      setStatus("Ready.");
    }

    async function startRun() {
      if (!pyodide || running) return;
      clearLog();
      setStatus("Running...");
      running = true;

      const userCode = codeEditor.value;
      pyodide.globals.set("user_code", userCode);

      try {
        pyodide.runPython(`
# compile_user_code() also resets engine
code_iter = engine.compile_user_code(user_code)
        `);
      } catch (e) {
        running = false;
        setStatus("Stopped: error in program.");
        log(String(e));
        return;
      }

      step();
    }

    function step() {
      if (!running) return;
      try {
        pyodide.runPython("next(code_iter)");
        const delay = Number(speedEl.value);
        setTimeout(step, delay);
      } catch (e) {
        const msg = String(e);
        if (!msg.includes("StopIteration")) {
          log(msg);
          setStatus("Stopped: error in program.");
        } else if (running) {
          setStatus("Finished.");
        }
        running = false;
      }
    }

    async function reset() {
      if (!pyodide) return;
      running = false;
      clearLog();
      setStatus("Reset.");
      pyodide.runPython("engine.reset()");
    }

    runBtn.addEventListener("click", startRun);
    resetBtn.addEventListener("click", reset);

    init();
  </script>
</body>
</html>
